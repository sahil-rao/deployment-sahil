---
# This Playbook would deploy the whole Baazdata cluster with replication and sharding.


- hosts: localhost
  tasks:
  - name: Start Mongo
    shell: mongod --fork --logpath /mnt/volume1/mongo/log/mongo.log -dbpath /mnt/volume1/mongo/db
    ignore_errors: True

  - name: Untar flightpath
    shell: tar -zxf /home/ubuntu/flightpath-deployment.tar.gz chdir=/
  - name: Copy the service files
    shell: tar -zxf /home/ubuntu/Baaz-DataAcquisition-Service.tar.gz chdir=/
  - name: Remove any previous service that may be installed.
    shell: update-rc.d -f baazdataacquisition remove
  - name: Install baazdataacquisition Service.
    shell: update-rc.d baazdataacquisition defaults
  - name: Start baazdataacquisition Service.
    service: name=baazdataacquisition state=started

    #Start of Analytics module deployment.
  - name: Untar Analytics
    shell: tar -zxf /home/ubuntu/Baaz-Analytics.tar.gz chdir=/
  - name: Install Basestats scripts
    shell: tar -zxf /home/ubuntu/Baaz-Basestats-Report.tar.gz chdir=/usr/lib
  - name: Mysql user addition
    mysql_user: name=baazdep password=baazdep priv=*.*:ALL state=present
  - name: Mysql DB
    mysql_db: name=HADOOP_DEV state=present
  - name: Install Analytics Service
    shell: tar -zxf /home/ubuntu/Baaz-Analytics-Service.tar.gz chdir=/
  - name: Remove any previous service that may be installed.
    shell: update-rc.d -f baazmath remove
  - name: Install baazmath Service.
    shell: update-rc.d baazmath defaults
  - name: Start baazmath Service.
    service: name=baazmath state=started

    #Start of Compiler module deployment.
  - name: Untar Compiler binaries
    shell: tar -zxf /home/ubuntu/Baaz-Compiler.tar.gz chdir=/usr/lib
  - name: Install Compiler Service
    shell: tar -zxf /home/ubuntu/Baaz-Compile-Service.tar.gz chdir=/
  - name: Remove any previous service that may be installed.
    shell: update-rc.d -f baazcompile remove
  - name: Install baazxompile Service.
    shell: update-rc.d baazcompile defaults
  - name: Start Baaz Compiler Service.
    service: name=baazcompile state=started

  - name: Create mysql user
    mysql_user: name=baaz password=baaz priv=*.*:ALL state=present
  - name: Create mysql DB
    mysql_db: name=baazdata state=present
  - name: Untar flightpath
    shell: tar -zxf /home/ubuntu/flightpath-deployment.tar.gz chdir=/
  - name: Copy node upstart configuration file
    copy: src=/home/ubuntu/nodejs.conf dest=/etc/init/nodejs.conf
  - name: Untar Baazdata App
    shell: tar -zxf /home/ubuntu/xplain.io.tar.gz
  - name: Remove the existing deployed code
    file: path=/var/xplain state=absent
  - name: Move the new code
    shell: mv /home/ubuntu/xplain.io /var/xplain
  - name: Install npm modules.
    npm: path=/var/xplain
  - name: copy monitrc file
    copy: src=/home/ubuntu/monitrc dest=/etc/monit/monitrc
