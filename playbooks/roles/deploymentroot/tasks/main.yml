---
# - name: Create the Baaz config directory
#   file: path=/var/Baaz state=directory
#   sudo: yes
# - name: Save configuration file
#   template: src=hosts.cfg dest=/var/Baaz/hosts.cfg
#   sudo: yes
# - name: copy emails.cfg to /var/Baaz
#   template: src=emails.cfg dest=/var/Baaz/emails.cfg
#   sudo: yes
# - name: copy sender.txt.enc to /var/Baaz
#   copy: src=/home/ubuntu/build/deployment/playbooks/roles/deploymentroot/files/sender.txt.enc dest=/var/Baaz/sender.txt.enc
#   sudo: yes
# - name: copy python files
#   copy: src=/home/ubuntu/build/deployment/emailjobs/ dest=/home/ubuntu/siddharth/emailjobs/
# - name: Install S3 CMD
#   apt: pkg=s3cmd state=present
#   sudo: yes
# - name: Copy s3cmd config file
#   copy: src=/home/ubuntu/.s3cfg dest=/home/ubuntu/.s3cfg
# - name: Copy s3cmd config file
#   copy: src=/home/ubuntu/.s3cfg dest=~root/.s3cfg
#   sudo: yes
# - name: Get Flightpath
#   shell: s3cmd sync s3://baaz-deployment/flightpath-deployment.tar.gz .
# - name: Untar flightpath
#   shell: tar -zxf /home/ubuntu/flightpath-deployment.tar.gz chdir=/
#   sudo: yes
# - name: install pymongo
#   pip: name=pymongo
#   sudo: yes
# - name: install redis py
#   pip: name=redis
#   sudo: yes
# - name: change update email file to executables
#   file: path=/home/ubuntu/siddharth/emailjobs/uploadUpdateEmail.py owner=ubuntu group=ubuntu mode=0755
# - name: change failure email file to executables
#   file: path=/home/ubuntu/siddharth/emailjobs/failureUpdateEmail.py owner=ubuntu group=ubuntu mode=0755
# #- cron: name="update email job" hour="*/12" job="/home/ubuntu/siddharth/emailjobs/uploadUpdateEmails.py"
# #- cron: name="failure email job" minute="*/2" job="/home/ubuntu/siddharth/emailjobs/failureUpdateEmails.py"
########DEPENDENCIES#########
- name: Add nginx ppa
  apt_repository: repo='ppa:nginx/stable'
  sudo: yes
- name: Install nginx
  apt: name=nginx state=present
  sudo: yes
- name: Install apache2-utils
  apt: name=apache2-utils state=present
  sudo: yes
- name: Install S3 CMD
  apt: name=s3cmd state=present
  sudo: yes
- name: Install Python Pip
  apt: name=python-pip state=present
  sudo: yes
- name: Install requests python library
  pip: name=requests state=latest
  sudo: yes
########SET UP ENVIRONMENT########
- name: Stop nodejs
  service: name=nodejs state=stopped
  sudo: yes
  ignore_errors: true
- name: Create /var/xplain_admin
  file: path=/var/xplain_admin state=directory owner=root mode=0644
  sudo: yes
- name: Create /var/www
  file: path=/var/www state=directory
  sudo: yes
- name: Save configuration file
  template: src=hosts.cfg dest=/var/Baaz/hosts.cfg
  sudo: yes
- name: Copy password four letter words file
  copy: src=fourletterwords dest=/usr/share/dict/fourletterwords
  sudo: yes
- name: Copy create_user python script
  copy: src=create_user.py dest=/usr/local/bin/create_user.py
  sudo: yes
- name: Copy resend_activation python script
  copy: src=resend_activation.py dest=/usr/local/bin/resend_activation.py
  sudo: yes

########UNPACK S3 TARBALLS########
- name: Get xplain_admin
  shell: s3cmd sync s3://baaz-deployment/{{ BuildVersion }}xplain_admin.tar.gz /home/ubuntu/ 
- name: Get xplain_dashboard
  shell: s3cmd sync s3://baaz-deployment/{{ BuildVersion }}xplain_dashboard.tar.gz /home/ubuntu/ 
- name: Untar xplain_admin
  shell: tar -zxf /home/ubuntu/xplain_admin.tar.gz -C /home/ubuntu
- name: Untar xplain_dashboard
  shell: tar -zxf /home/ubuntu/xplain_dashboard.tar.gz -C /home/ubuntu
- name: Remove the existing deployed code (xplain_admin)
  file: path=/var/xplain_admin state=absent
  sudo: yes
- name: Remove the existing deployed code (xplain_dashboard)
  file: path=/var/www/ state=absent
  sudo: yes
- name: Move the new code (xplain_admin)
  shell: mv /home/ubuntu/xplain_admin /var/xplain_admin
  sudo: yes
- name: Move the new code (xplain_dashboard)
  shell: mv /home/ubuntu/xplain_dashboard /var/www
  sudo: yes
- name: Get the npm modules for xplain_admin
  npm: path=/var/xplain_admin
  sudo: yes
- name: Template out javascript for xplain_dashboard
  template: src=/home/ubuntu/build/UI/xplain_dashboard/js2/index.js dest=/var/www/js2/index.js
  sudo: yes
########DEPLOY AND CONFIGURE########
- name: Copy nginx conf file
  template: src=/home/ubuntu/build/UI/xplain_dashboard/nginx.conf dest=/etc/nginx/nginx.conf
  sudo: yes
- name: Copy different nginx conf file if staging (No SSL)
  template: src=/home/ubuntu/build/UI/xplain_dashboard/nginx.conf.staging dest=/etc/nginx/nginx.conf
  when: clusterName == 'xplain-staging'
  sudo: yes
- name: Copy node upstart script
  template: src=nodejs.conf dest=/etc/init/nodejs.conf
  sudo: yes
- name: Start nodejs
  service: name=nodejs state=started
  sudo: yes
- name: Create username/password
  command: /usr/bin/htpasswd -b -c /etc/nginx/.htpasswd xplain xplainio
  sudo: yes 
- name: Start nginx
  command: /usr/sbin/nginx
  sudo: yes
  ignore_errors: yes
- name: Reload nginx
  command: /usr/sbin/nginx -s reload
  sudo: yes
- name: Get Flightpath
  shell: s3cmd sync s3://baaz-deployment/{{ BuildVersion }}flightpath-deployment.tar.gz .
- name: Untar flightpath
  shell: tar -zxf /home/ubuntu/flightpath-deployment.tar.gz chdir=/
  sudo: yes
- name: install networkx
  pip: name=networkx
  sudo: yes
- name: Install Elasticsearch
  pip: name=elasticsearch
  sudo: yes
